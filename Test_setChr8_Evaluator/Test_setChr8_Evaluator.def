Bootstrap: docker
From: python:3.13-slim
Stage: build

%files
    /scratch/st-cdeboer-1/iluthra/game_apis/RestAPI/game_prod/Evaluators/Orca_Evaluators/Test_setChr8_Evaluator/config.py /Test_setChr8_Evaluator/config.py
    /scratch/st-cdeboer-1/iluthra/game_apis/RestAPI/game_prod/Evaluators/Orca_Evaluators/Test_setChr8_Evaluator/data_loader.py /Test_setChr8_Evaluator/data_loader.py
    /scratch/st-cdeboer-1/iluthra/game_apis/RestAPI/game_prod/Evaluators/Orca_Evaluators/Test_setChr8_Evaluator/evaluator_content_handler.py /Test_setChr8_Evaluator/evaluator_content_handler.py 
    /scratch/st-cdeboer-1/iluthra/game_apis/RestAPI/game_prod/Evaluators/Orca_Evaluators/Test_setChr8_Evaluator/evaluator_metrics_calculator.py /Test_setChr8_Evaluator/evaluator_metrics_calculator.py
    /scratch/st-cdeboer-1/iluthra/game_apis/RestAPI/game_prod/Evaluators/Orca_Evaluators/Test_setChr8_Evaluator/evaluator_RestAPI.py /Test_setChr8_Evaluator/evaluator_RestAPI.py

%environment
    # Prevent automatic binding of host directories
    export APPTAINER_NO_MOUNT="home,tmp,proc,sys,dev"
    export LC_ALL=C
    export PATH="/opt/conda/envs/orca_env/bin:$PATH"
    export LD_LIBRARY_PATH="/opt/conda/envs/orca_env/lib:$LD_LIBRARY_PATH"
    # seqstr env variable to get sequence
    export GENOME_PATH='/orca/resources/'


%post
    #!/bin/bash
    echo "Installing system dependencies..."
    apt-get update && \
    apt-get install -y --no-install-recommends git wget bzip2 ca-certificates && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

    echo "Installing Miniconda..."
    mkdir -p /opt && \
    wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /opt/miniconda.sh && \
    chmod +x /opt/miniconda.sh
    bash /opt/miniconda.sh -b -p /opt/conda && \
    rm -rf /opt/miniconda.sh

    # echo "Installing mamba..."
    export PATH="/opt/conda/bin:$PATH"
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
    conda install -y -n base -c conda-forge mamba
    . /opt/conda/etc/profile.d/mamba.sh

    echo "Getting orca repo..."
    cd /
    git clone https://github.com/jzhoulab/orca.git
    cd orca

    echo "Creating Conda environment 'orca_env'..."
    # conda clean --all --yes
    mamba env create -f orca_env_part1.yml -y
    mamba activate orca_env

    pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
    pip install msgpack_numpy
    mamba env update -f orca_env_part2.yml -y

    git clone https://github.com/kathyxchen/selene.git
    cd selene
    git checkout custom_target_support
    python setup.py build_ext --inplace
    python setup.py install 

    echo "Verifying Conda environment creation..."
    if ! conda env list | grep -q orca_env; then
        echo "Error: Conda environment 'orca' was not created successfully."
        exit 1
    fi

    echo "getting target values and hg38 reference genome"
    cd /orca
    wget https://zenodo.org/record/6234936/files/resources_core.tar.gz
    tar -xf resources_core.tar.gz --no-same-owner
    rm resources_core.tar.gz
    # target files, around 34G
    wget https://zenodo.org/record/6234936/files/resources_mcools.tar.gz 
    tar -xf resources_mcools.tar.gz --no-same-owner
    rm resources_mcools.tar.gz

    echo "Installing additional Python packages..."
    pip install flask msgpack msgpack_numpy requests

    echo "Setting permissions for directories and script..."
    chmod -R 755 /Test_setChr8_Evaluator

%runscript
    export PATH="/opt/conda/envs/orca_env/bin:$PATH"
    exec python /Test_setChr8_Evaluator/evaluator_RestAPI.py "$@"
 
%startscript
    export PATH="/opt/conda/envs/orca_env/bin:$PATH"
    exec python /Test_setChr8_Evaluator/evaluator_RestAPI.py "$@"


%labels
    Author "Rui Guo with edits from Ishika Luthra"
    Version "3.0"
    Description "This container is the Validation Set Chr10 Evaluator set up for Genomic API for Model Evaluation for the ORCA Predictor."

%help
    This container includes:
    - Evaluator API script for genomic sequence evaluation.
    - Installed Python dependencies required by the Evaluator.

    